# EMEWS-PhysiBoSS AGS post-calibration analysis

The first one we have to employ is the `summarize_deap_run.py` script.
* Input: Path to the experiment folder.
* Output: Creates a CSV file with the summary in the `results/` folder. Also creates a folder with the name of the experiment, where the top 10, 20, 50 and 100 instances are in CSV format.


Then, with this CSV we can perform different analyses.

## Plotting the top N instances from a given experiment (topN_curves_plot.py)


## Convergence Plot (convergence_plot.py)

## Comparing Top Parameter Distributions (compare_top_params.py)

This script is designed to perform a comprehensive statistical comparison of parameter distributions derived from the top-performing runs of different calibration experiments (e.g., single-drug CMA/GA runs). Its primary purpose is to identify which parameters have significantly different distributions between experiments, which have similar distributions, and to use this information to create new, informed parameter spaces for subsequent synergy experiments.

### Logic and Purpose

The core idea is to take the parameter distributions from two or more initial experiments (e.g., a model calibrated for Drug A and a model calibrated for Drug B) and determine how to best combine them for a new experiment (e.g., a synergy experiment with Drug A + Drug B).

- **Statistical Significance**: It uses the Mann-Whitney U test to determine if the differences between parameter distributions are statistically significant.
- **Distribution Merging**: Based on the statistical tests, it can generate new parameter files for sweeps or genetic algorithms.
  - If distributions are **not** significantly different, it assumes they represent the same underlying biology and takes their **intersection** (the overlapping range).
  - If distributions are **significantly** different, it assumes they are both valid but under different conditions, and takes their **union** (the combined, widest range).
- **Visualization and Reporting**: It generates a variety of plots (boxplots, pairplots) and summary tables (CSV files) to visualize the comparisons and report the statistical results.

### Inputs

- **Top N% Parameter Distributions**: JSON files generated by `summarize_deap_run.py` or a similar script. These files contain the mean, standard deviation, min, max, and count for each parameter's distribution within the top individuals. Example: `final_summary_{experiment_name}_param_distribution_top_10p.json`.
- **Top N% Raw Instances**: For some plots (like the pairplot), it uses the raw CSV file of the top individuals. Example: `top_10p.csv`.
- **Template XML file**: A PhysiCell/PhysiBoSS configuration file used as a template for generating new configuration files based on averaged parameter values.

### Key Functions and Outputs

- `run_tests_for_all_params`:
  - **Function**: Compares common, non-drug-specific parameters between two experiments using the Mann-Whitney U test.
  - **Output**: A CSV file (e.g., `final_summary_{exp1}_and_{exp2}_top_{top_n}_comparison.csv`) detailing the test statistics and p-values for each parameter.

- `generate_combined_sweep` / `generate_combined_distribution`:
  - **Function**: Creates a new parameter distribution file (in JSON format) for a synergy experiment based on the comparison of two single-drug experiments. It intelligently handles drug-specific parameters, renaming `drug_X` from the second experiment to `drug_Y`.
  - **Output**: JSON files suitable for configuring a new parameter sweep or DEAP run.

- `plot_parameter_distributions` / `plot_parameter_distributions_extended`:
  - **Function**: Generates boxplots to visually compare the distributions of common parameters across two or more experiments. The plots are annotated with significance stars from the statistical tests.
  - **Output**: PNG files of the boxplots (e.g., `combined_dist_{exp1}_{exp2}.png`).

- `generate_pairplot_from_top_instances`:
  - **Function**: Creates a `seaborn` pairplot to visualize correlations and distributions of the top parameter sets from multiple experiments, with points colored by the source experiment.
  - **Output**: A high-quality pairplot saved in both PNG and PDF format.

- `generate_parameter_statistics_table` / `generate_synergy_comparison_table`:
  - **Function**: Produces detailed summary tables in CSV format that list the mean, standard deviation, effect size (Cohen's d), and distribution overlap for each parameter across the compared conditions.
  - **Output**: Comprehensive CSV files for detailed analysis and reporting.

- `generate_xml_from_average_params`:
    - **Function**: Takes the average values from a top parameter distribution and populates a template XML configuration file with them.
    - **Output**: A new XML file (e.g., `..._top10p_averaged.xml`) that can be used to run a single simulation with a "representative" or "averaged" top-performing parameter set.
