# PhysiBoSS to ParaView Converter

## Overview

This Python script converts output files from PhysiBoSS cell simulations into a format that can be visualized in ParaView, a popular open-source data analysis and visualization application. The converter transforms the MATLAB (`.mat`) and XML (`.xml`) files generated by PhysiBoSS into VTK Unstructured Grid (`.vtu`) files that ParaView can directly read and visualize.

## Features

- Converts cell spatial positions and attributes from PhysiBoSS simulations to ParaView format
- Preserves all metadata and cell properties from the original simulation
- Creates a time series collection (`.pvd`) file for animating the simulation in ParaView
- Handles multiple timesteps automatically
- Uses the actual timestep numbers from original simulation files
- Properly manages scalar and vector data fields
- Provides error handling for missing or malformed input files
- Supports customization of output file naming

## Requirements

- Python 3.6+
- VTK Python bindings
- SciPy (for reading `.mat` files)
- NumPy
- ParaView (for visualization)

## How It Works

The script performs several key operations to convert PhysiBoSS simulation data:

1. **XML Parsing**: Extracts field metadata (names, sizes, units) from the XML files
2. **Data Loading**: Reads cell positions and properties from MATLAB files
3. **VTK Conversion**: Creates VTK data structures for visualization
4. **Time Series Handling**: Manages multiple timesteps and creates a PVD file

### Main Components

#### 1. Label Parsing (`parse_physiboss_labels`)

This function reads the XML files that accompany PhysiBoSS output to extract metadata about each field in the simulation data, including:
- Field names
- Data dimensions (scalar vs vector)
- Units of measurement
- Index positions within the data structure

#### 2. MAT to VTU Conversion (`mat_to_vtu`)

The core conversion function that:
- Reads a MATLAB file containing cell data for a single timestep
- Creates VTK point structures from cell positions
- Adds cell attributes as VTK cell data
- Handles both scalar fields (e.g., cell radius) and vector fields (e.g., velocity)
- Writes the result to a VTU file

#### 3. PVD Creation (`create_pvd`)

This function organizes multiple timesteps into a coherent time series by:
- Locating all MAT files in the simulation output directory
- Extracting the exact timestep numbers directly from the filenames
- Converting each timestep to VTU format
- Creating a ParaView Data (PVD) file that indexes all timesteps with their actual time values
- Managing file paths for proper ParaView loading
- Providing clear information about output file locations

## Usage Examples

### Basic Conversion

```bash
python physiboss_paraview_viewer.py /path/to/simulation/output
```

### Cleaning Existing Files First

```bash
python physiboss_paraview_viewer.py /path/to/simulation/output --clean
```

### Using Custom File Prefix

```bash
python physiboss_paraview_viewer.py /path/to/simulation/output --prefix "cells"
```

## Visualization in ParaView

After running the script, you can:

1. Open ParaView
2. Use "File â†’ Open" to select the generated `.pvd` file
3. Click "Apply" in the Properties panel
4. Use the time navigation controls to browse through the simulation timesteps
5. Apply various visualization filters to explore the data

The cell data is represented as points in 3D space, with all the original cell properties (e.g., cell type, cycle state, various molecular markers) available as data fields that can be used for coloring, filtering, or further analysis.

## Output Files

The script generates two types of files:
- `.vtu` files: One for each timestep in the simulation, containing all cell data
- A single `.pvd` file: An index file that organizes all timesteps for ParaView

The script clearly reports where these files are saved, showing absolute paths for easy navigation.

## Timestep Handling

The converter extracts the actual simulation timestep numbers directly from the original filenames. This ensures that:
- The temporal spacing in ParaView exactly matches the original simulation
- No artificial time intervals are imposed on the data
- The visualization accurately represents the simulation timeline

## Advanced Visualization

### Cell Geometries in ParaView

The script stores cell geometry information as points with attributes, allowing flexible visualization in ParaView. Here's how to visualize cells with different shapes:

#### Method 1: Simple Visualization (All cells same type)
1. Open the PVD file in ParaView
2. Click "Apply" in the Properties panel
3. Add a Glyph filter:
   - Click 'Filters' > 'Alphabetical' > 'Glyph'
4. In the Glyph properties panel:
   - Set "Glyph Type" to Sphere or Cylinder
   - Set "Scale Array" to "radius"
   - Adjust "Scale Factor" as needed (try 1.0 initially)
   - For cylinders, turn on "Orient" if you have orientation data

#### Method 2: Mixed Cell Types (Spheres and Cylinders)
1. First, separate cell types:
   - Add "Threshold" filter
   - Set "cell_type" as the array to threshold
   - For spherical cells: set value to 0
   - For cylindrical cells: set value to 1
2. For spherical cells (cell_type = 0):
   - Add Glyph filter to the threshold output
   - Set Glyph Type to Sphere
   - Scale by radius
   - Orient: Off
3. For cylindrical cells (cell_type = 1):
   - Add another Glyph filter
   - Set Glyph Type to Cylinder
   - Scale by radius
   - Orient: On (if orientation data available)

#### Customization Tips
- **Coloring**: Use the "Coloring" dropdown to color cells by any data field
- **Size Adjustment**: 
  - Use "Scale Factor" to make all cells larger or smaller
  - The "radius" array controls individual cell sizes
- **Resolution**: Adjust "Resolution" parameters for smoother spheres/cylinders
- **Orientation**: For cylinders, orientation can be controlled if you have vector data

#### Available Cell Types
- Type 0: Spherical cells (default)
- Type 1: Cylindrical cells (e.g., rod-shaped bacteria)

#### Data Fields
The converter provides several key fields for visualization:
- `cell_type`: Determines the cell shape (0=sphere, 1=cylinder)
- `radius`: Controls the cell size
- Additional fields from the original data can be used for coloring or filtering

## Troubleshooting

- **File not found errors**: Ensure all XML and MAT files follow the expected naming convention
- **Missing data fields**: Check that the XML file properly defines all expected fields
- **Visualization issues**: Try using "Reset Camera" in ParaView if cells are not visible
- **Timestep extraction failures**: Make sure filenames follow the format with timestep numbers (e.g., `output_00000123_cells.mat`)

## References
- [VTK File Formats](https://vtk.org/wp-content/uploads/2015/04/file-formats.pdf)
- [PhysiCell Documentation](https://physicell.org/)